<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compras Grupales - Lazo Mercado</title>

  <!-- Fuentes e √≠conos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#4CAF50;
      --primary-light:#66BB6A;
      --primary-strong:#2E7D32;
      --bg:linear-gradient(135deg, #f5f7fa 0%, #e8f5e9 100%);
      --card:#fff;
      --muted:#757575;
      --danger:#EF5350;
      --success:#66BB6A;
      --glass: rgba(255,255,255,0.95);
      --shadow: 0 10px 30px rgba(0,0,0,0.08);
      --shadow-hover: 0 15px 40px rgba(0,0,0,0.12);
    }
    *{box-sizing:border-box;transition:all 0.3s ease}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:#333;margin:0;line-height:1.6;min-height:100vh}
    header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-strong) 100%);color:#fff;padding:20px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;box-shadow:0 4px 20px rgba(0,0,0,0.1)}
    .brand{display:flex;gap:16px;align-items:center}
    .brand h1{font-size:1.4rem;margin:0;font-weight:600}
    .brand p{margin:0;font-size:.95rem;opacity:.9}
    .container{max-width:1200px;margin:32px auto;padding:20px}
    .card{background:var(--glass);border-radius:20px;padding:28px;box-shadow:var(--shadow);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.3);transition:transform 0.3s ease, box-shadow 0.3s ease}
    .card:hover{box-shadow:var(--shadow-hover);transform:translateY(-2px)}
    .grid{display:grid;gap:16px}
    /* PRODUCT GRID (CLIENT) */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-top:20px}
    .product-card{border:2px solid rgba(76,175,80,0.2);border-radius:16px;padding:20px;background:linear-gradient(135deg, #fff 0%, #f1f8f4 100%);display:flex;flex-direction:column;gap:12px;transition:all 0.3s ease;box-shadow:0 4px 12px rgba(0,0,0,0.05)}
    .product-card:hover{border-color:var(--primary);transform:translateY(-4px);box-shadow:0 8px 20px rgba(0,0,0,0.1)}
    .product-name{font-weight:600;font-size:1.1rem;color:var(--primary-strong)}
    .product-unit{font-size:.95rem;color:var(--muted);background:rgba(76,175,80,0.1);padding:6px 12px;border-radius:8px;display:inline-block}
    .qty-row{display:flex;gap:10px;align-items:center;margin-top:10px}
    .qty-row input{flex:1;padding:12px;border-radius:12px;border:2px solid rgba(76,175,80,0.2);font-size:1rem;transition:border-color 0.3s ease}
    .qty-row input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(76,175,80,0.1)}
    /* BUTTONS */
    .btn{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-strong) 100%);color:#fff;border:0;padding:14px 24px;border-radius:12px;font-weight:600;cursor:pointer;font-size:1rem;box-shadow:0 4px 12px rgba(76,175,80,0.3);transition:all 0.3s ease}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(76,175,80,0.4)}
    .btn:active{transform:translateY(0)}
    .btn.gray{background:linear-gradient(135deg,#78909C 0%,#546E7A 100%);box-shadow:0 4px 12px rgba(120,144,156,0.3)}
    .btn.danger{background:linear-gradient(135deg,#EF5350 0%,#C62828 100%);box-shadow:0 4px 12px rgba(239,83,80,0.3)}
    .btn.small{padding:10px 16px;font-size:.9rem}
    .muted{color:var(--muted)}
    .small{font-size:.9rem;color:var(--muted)}
    /* ADMIN */
    .admin-header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid rgba(76,175,80,0.2)}
    .admin-controls{display:flex;gap:10px;flex-wrap:wrap}
    .orders-table{width:100%;border-collapse:collapse;margin-top:16px;font-size:.95rem;border-radius:12px;overflow:hidden}
    .orders-table th{background:linear-gradient(135deg,rgba(76,175,80,.12) 0%,rgba(76,175,80,.08) 100%);padding:14px;text-align:left;border-bottom:2px solid rgba(76,175,80,0.2);font-weight:600;color:var(--primary-strong)}
    .orders-table td{padding:14px;border-bottom:1px solid rgba(0,0,0,0.05);vertical-align:middle}
    .orders-table tr{transition:background 0.2s ease}
    .orders-table tr:hover{background:rgba(76,175,80,0.04)}
    .orders-products{color:var(--muted);font-size:.92rem;line-height:1.4}
    .order-actions{display:flex;gap:10px;justify-content:flex-end}
    .icon-btn{width:42px;height:42px;border-radius:12px;border:0;color:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.1);transition:all 0.3s ease}
    .icon-btn:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,.15)}
    .icon-pay{background:linear-gradient(135deg,#42A5F5 0%,#1E88E5 100%)}
    .icon-view{background:linear-gradient(135deg,#78909C 0%,#546E7A 100%)}
    .icon-delete{background:linear-gradient(135deg,#EF5350 0%,#C62828 100%)}
    td.actions{width:160px;max-width:160px}
    /* MODALS */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px);z-index:9999;align-items:center;justify-content:center;padding:16px;animation:fadeIn 0.3s ease}
    .modal.show{display:flex}
    .modal-box{width:100%;max-width:800px;background:#fff;border-radius:20px;padding:28px;max-height:92vh;overflow:auto;position:relative;box-shadow:0 20px 60px rgba(0,0,0,0.2);animation:slideUp 0.3s ease}
    .close-modal{position:absolute;right:20px;top:16px;font-size:24px;cursor:pointer;color:var(--muted);transition:color 0.3s ease,transform 0.3s ease}
    .close-modal:hover{color:var(--danger);transform:rotate(90deg)}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    /* Admin product row */
    .prod-admin-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
    .prod-admin-row input, .prod-admin-row select{width:calc(100% / 4 - 10px);min-width:140px;padding:12px;border-radius:12px;border:2px solid rgba(76,175,80,0.2);transition:border-color 0.3s ease}
    .prod-admin-row input:focus, .prod-admin-row select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(76,175,80,0.1)}
    .prod-admin-row .avail{width:140px}
    /* FINANZAS */
    .fin-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .list{max-height:320px;overflow:auto;padding:12px;border-radius:12px;border:2px solid rgba(0,0,0,0.08);background:rgba(255,255,255,0.5)}
    .list-item{padding:10px;border-bottom:1px solid rgba(0,0,0,0.05);display:flex;justify-content:space-between}
    .badge{display:inline-block;padding:6px 12px;border-radius:8px;background:rgba(76,175,80,0.1);color:var(--primary-strong);font-weight:500}
    /* Improved input and textarea styles */
    input[type="text"], input[type="tel"], input[type="email"], input[type="password"], input[type="number"], textarea, select{width:100%;padding:14px;border-radius:12px;border:2px solid rgba(76,175,80,0.2);font-family:'Poppins',sans-serif;font-size:1rem;transition:all 0.3s ease}
    input:focus, textarea:focus, select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(76,175,80,0.1)}
    label{display:block;margin-bottom:8px;font-weight:500;color:var(--primary-strong);font-size:.95rem}
    @media (max-width:720px){ .prod-admin-row input, .prod-admin-row select{width:100%} .fin-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <i class="fas fa-shopping-basket" style="font-size:20px"></i>
    <div>
      <h1>Compras Grupales ‚Äî Lazo Mercado</h1>
      <p class="small muted">Control de pedidos y pagos</p>
    </div>
  </div>
  <div>
    <button id="admin-login-link" class="btn"><i class="fas fa-user-shield" style="margin-right:8px"></i> Administrador</button>
  </div>
</header>

<div class="container">
  <!-- CLIENT FORM -->
  <div class="card" style="background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(241,248,244,0.95) 100%);border:2px solid rgba(76,175,80,0.3)">
    <div style="text-align:center;margin-bottom:24px">
      <h2 style="margin:0 0 8px 0;color:var(--primary-strong);font-size:2rem;font-weight:600">
        <i class="fas fa-shopping-cart" style="margin-right:12px;color:var(--primary)"></i>Realiza tu pedido
      </h2>
      <p style="color:var(--muted);font-size:1.05rem;margin:0">Completa el formulario y confirma tu compra</p>
    </div>

    <div class="grid">
      <div>
        <label><i class="fas fa-user" style="margin-right:8px;color:var(--primary)"></i>Nombre completo</label>
        <input id="nombre" type="text" placeholder="Ej: Juan P√©rez Garc√≠a">
      </div>

      <div>
        <label><i class="fas fa-phone" style="margin-right:8px;color:var(--primary)"></i>Tel√©fono de contacto</label>
        <input id="telefono" type="tel" placeholder="Ej: +56912345678">
      </div>

      <div>
        <label><i class="fas fa-box-open" style="margin-right:8px;color:var(--primary)"></i>Selecciona tus productos</label>
        <div id="product-grid" class="product-grid"></div>
      </div>

      <div>
        <label><i class="fas fa-comment-dots" style="margin-right:8px;color:var(--primary)"></i>Comentarios adicionales / Direcci√≥n de despacho</label>
        <textarea id="comentarios" rows="3" placeholder="Ej: Departamento 302, Edificio Las Flores, Calle Principal #123" style="resize:vertical"></textarea>
      </div>

      <div style="text-align:center;margin-top:12px">
        <button id="enviar-pedido" class="btn" style="font-size:1.1rem;padding:16px 40px">
          <i class="fas fa-paper-plane" style="margin-right:10px"></i>Enviar mi pedido
        </button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-container" class="card" style="display:none;margin-top:24px;opacity:0;transition:opacity 0.5s ease">
    <div class="admin-header">
      <div>
        <h3 style="margin:0;color:var(--primary-strong);font-size:1.5rem;font-weight:600">
          <i class="fas fa-user-shield" style="margin-right:10px;color:var(--primary)"></i>Panel Administrador
        </h3>
        <div class="small muted" style="margin-top:4px">Gestiona productos y pedidos de forma eficiente</div>
      </div>
      <div class="admin-controls">
        <button id="add-order-btn" class="btn small"><i class="fas fa-plus-circle" style="margin-right:6px"></i>Agregar pedido</button>
        <button id="export-btn" class="btn small gray"><i class="fas fa-file-csv" style="margin-right:6px"></i>Exportar CSV</button>
        <button id="refresh-btn" class="btn small" style="background:linear-gradient(135deg,#66BB6A 0%,#2E7D32 100%)"><i class="fas fa-sync-alt" style="margin-right:6px"></i>Actualizar</button>
        <button id="logout-btn" class="btn small danger"><i class="fas fa-sign-out-alt" style="margin-right:6px"></i>Salir</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
      <input id="search-input" placeholder="üîç Buscar por nombre o tel√©fono..." style="flex:1;padding:14px;border-radius:12px;border:2px solid rgba(76,175,80,0.2)">
      <select id="payment-filter" style="min-width:220px;padding:14px;border-radius:12px;border:2px solid rgba(76,175,80,0.2)">
        <option value="all">üìã Todos los pedidos</option>
        <option value="pendiente">‚è≥ Pendientes</option>
        <option value="parcial">üìä Parciales</option>
        <option value="pagado">‚úÖ Pagados</option>
        <option value="moroso">‚ö†Ô∏è Morosos (+30 d√≠as)</option>
      </select>
    </div>

    <table class="orders-table" aria-describedby="orders">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Tel√©fono</th>
          <th>Productos</th>
          <th>Comentarios (Despacho)</th>
          <th>Total</th>
          <th>Pago</th>
          <th>Fecha</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>

    <!-- PRODUCTS ADMIN -->
    <div style="margin-top:20px;">
      <div class="card" style="background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(241,248,244,0.95) 100%)">
        <h4 style="margin:0;color:var(--primary-strong);font-size:1.2rem;font-weight:600">
          <i class="fas fa-cogs" style="margin-right:10px;color:var(--primary)"></i>Configuraci√≥n de productos
        </h4>
        <p style="color:var(--muted);font-size:.9rem;margin:8px 0 0 0">Administra los productos disponibles en la plataforma</p>
        <div id="products-admin" style="margin-top:16px"></div>
        <div style="margin-top:16px;display:flex;gap:12px;">
          <button id="save-products-btn" class="btn"><i class="fas fa-save" style="margin-right:8px"></i>Guardar productos</button>
          <button id="reset-products-btn" class="btn danger"><i class="fas fa-undo" style="margin-right:8px"></i>Restablecer</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ORDER SUMMARY MODAL -->
<div id="order-summary-modal" class="modal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-modal" id="close-order-summary">&times;</span>
    <h2 style="color:var(--primary-strong);font-weight:600"><i class="fas fa-receipt" style="margin-right:10px;color:var(--primary)"></i>Resumen de tu pedido</h2>
    <div id="summary-items" style="margin-top:16px;border:2px solid rgba(76,175,80,0.2);border-radius:12px;padding:16px;background:rgba(241,248,244,0.3)"></div>

    <div style="display:flex;gap:16px;align-items:center;margin-top:20px;flex-wrap:wrap">
      <div style="flex:1;min-width:250px">
        <label><i class="fas fa-credit-card" style="margin-right:8px;color:var(--primary)"></i>M√©todo de pago</label>
        <select id="summary-payment-method" style="width:100%;padding:14px;border-radius:12px;border:2px solid rgba(76,175,80,0.2)">
          <option value="efectivo">üíµ Efectivo (al recibir)</option>
          <option value="transferencia">üí≥ Transferencia / Mercado Pago</option>
        </select>
      </div>

      <div style="display:flex;gap:12px;">
        <button id="confirm-order" class="btn"><i class="fas fa-check-circle" style="margin-right:8px"></i>Confirmar</button>
        <button id="reject-order" class="btn gray"><i class="fas fa-times-circle" style="margin-right:8px"></i>Cancelar</button>
      </div>
    </div>

    <div id="summary-transfer-details" style="display:none;margin-top:20px;">
      <div class="card" style="background:linear-gradient(135deg,rgba(33,150,243,0.1) 0%,rgba(30,136,229,0.05) 100%);border:2px solid rgba(33,150,243,0.3)">
        <strong style="color:var(--primary-strong);font-size:1.1rem"><i class="fas fa-info-circle" style="margin-right:8px;color:#2196F3"></i>Datos para transferencia / Mercado Pago</strong>
        <div class="muted small" style="margin-top:8px;">Usa estos datos solo si seleccionas transferencia</div>
        <div style="margin-top:12px;font-weight:600;line-height:1.8">
          üë§ √Ålvaro Aaron Lazo Reyes<br>
          üÜî RUT: 168400896<br>
          üè¶ Cuenta Vista - N√∫mero de cuenta: <b style="color:var(--primary-strong)">1014726096</b><br>
          üìß Email Mercado Pago: <b style="color:var(--primary-strong)">alvarolazo18@gmail.com</b>
        </div>
      </div>
    </div>

    <div style="text-align:right;margin-top:20px;padding:16px;background:linear-gradient(135deg,rgba(76,175,80,0.1) 0%,rgba(46,125,50,0.05) 100%);border-radius:12px">
      <span style="font-size:1.1rem;color:var(--muted)">Total a pagar: </span>
      <span id="summary-total" style="font-weight:700;color:var(--primary-strong);font-size:1.8rem">$0</span>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL (ADMIN) -->
<div id="payment-modal" class="modal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-modal" id="close-payment">&times;</span>
    <h2 style="color:var(--primary-strong);font-weight:600"><i class="fas fa-money-bill-wave" style="margin-right:10px;color:var(--primary)"></i>Registrar pago</h2>
    <div id="payment-client-info" class="muted small" style="margin-top:10px;padding:12px;background:rgba(76,175,80,0.1);border-radius:8px"></div>

    <div style="margin-top:16px">
      <label><i class="fas fa-dollar-sign" style="margin-right:8px;color:var(--primary)"></i>Monto del pago</label>
      <input id="payment-amount" type="number" min="0" step="100" placeholder="Ingrese el monto">
    </div>
    <div style="margin-top:16px">
      <label><i class="fas fa-wallet" style="margin-right:8px;color:var(--primary)"></i>M√©todo de pago</label>
      <select id="payment-method">
        <option value="efectivo">üíµ Efectivo</option>
        <option value="transferencia">üí≥ Transferencia</option>
      </select>
    </div>
    <div style="margin-top:16px">
      <label><i class="fas fa-sticky-note" style="margin-right:8px;color:var(--primary)"></i>Notas adicionales</label>
      <textarea id="payment-notes" rows="2" placeholder="Notas o comentarios sobre el pago"></textarea>
    </div>

    <div style="display:flex;gap:12px;margin-top:20px;flex-wrap:wrap">
      <button id="register-payment" class="btn"><i class="fas fa-save" style="margin-right:8px"></i>Registrar pago</button>
      <button id="mark-as-paid" class="btn" style="background:linear-gradient(135deg,#66BB6A 0%,#2E7D32 100%)"><i class="fas fa-check-double" style="margin-right:8px"></i>Marcar como pagado</button>
      <button id="toggle-payment-history" class="btn gray"><i class="fas fa-history" style="margin-right:8px"></i>Ver historial</button>
    </div>

    <div id="payment-history-container" style="display:none;margin-top:20px;">
      <h4 style="color:var(--primary-strong);margin:0 0 12px 0"><i class="fas fa-list" style="margin-right:8px"></i>Historial de pagos</h4>
      <div id="modal-payment-history" class="list"></div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="login-modal" class="modal">
  <div class="modal-box" style="max-width:500px">
    <span class="close-modal" id="close-login">&times;</span>
    <div style="text-align:center;margin-bottom:24px">
      <div style="width:80px;height:80px;margin:0 auto 16px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-strong) 100%);border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 20px rgba(76,175,80,0.3)">
        <i class="fas fa-user-shield" style="font-size:40px;color:#fff"></i>
      </div>
      <h2 style="margin:0;color:var(--primary-strong);font-weight:600">Acceso Administrador</h2>
      <p style="color:var(--muted);margin:8px 0 0 0">Ingresa tus credenciales para continuar</p>
    </div>
    <div style="margin-top:20px">
      <label><i class="fas fa-envelope" style="margin-right:8px;color:var(--primary)"></i>Correo electr√≥nico</label>
      <input id="admin-email" type="email" placeholder="admin@valledor.com">
    </div>
    <div style="margin-top:20px">
      <label><i class="fas fa-lock" style="margin-right:8px;color:var(--primary)"></i>Contrase√±a</label>
      <input id="admin-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
    </div>
    <div style="display:flex;gap:12px;margin-top:24px;">
      <button id="login-btn" class="btn" style="flex:1"><i class="fas fa-sign-in-alt" style="margin-right:8px"></i>Iniciar sesi√≥n</button>
      <button id="cancel-login" class="btn gray"><i class="fas fa-times" style="margin-right:8px"></i>Cancelar</button>
    </div>
    <div id="login-error" class="muted" style="color:var(--danger);display:none;margin-top:16px;padding:12px;background:rgba(239,83,80,0.1);border-radius:8px;text-align:center">
      <i class="fas fa-exclamation-triangle" style="margin-right:8px"></i>Credenciales incorrectas. Int√©ntalo de nuevo.
    </div>
  </div>
</div>

<!-- Notification -->
<div id="notification" style="position:fixed;right:20px;top:20px;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-strong) 100%);color:#fff;padding:16px 24px;border-radius:12px;display:none;z-index:9999;box-shadow:0 8px 24px rgba(76,175,80,0.4);font-weight:500;animation:slideIn 0.3s ease">
  <i class="fas fa-check-circle" style="margin-right:10px"></i><span id="notification-text"></span>
</div>
<style>
@keyframes slideIn{from{opacity:0;transform:translateX(100px)}to{opacity:1;transform:translateX(0)}}
</style>

<script>
/*
  Consolidated index.html implementing:
  - Admin product config: choose base selling unit (kg / caja / g / saco)
  - Client view: shows all products (regardless of stock) with chosen unit, user inputs qty
  - On "Enviar pedido": modal summary with 2 payment options (efectivo / transferencia)
    - If transferencia selected, shows Mercado Pago transfer information
    - Confirm creates order saved in localStorage and shows "Gracias por la compra" notification
  - Admin panel: list orders, register payments (modal), export CSV, add manual orders
  - All main buttons wired. No stock is shown to client.
  - Orders are kept in localStorage; optional backend sending can be added later
*/

/* ====== App State & Defaults ====== */
const DEFAULT_PRODUCTOS = {
  paltas: { key:'paltas', nombre:'Paltas', precio:3500, baseUnit:'kg', sacoKg:25, disponible:true },
  champi: { key:'champi', nombre:'Champi√±ones', precio:2500, baseUnit:'caja', packGramos:250, disponible:true },
  frutillas: { key:'frutillas', nombre:'Frutillas', precio:1200, baseUnit:'g', bloqueGramos:100, disponible:true }
};

let productos = structuredClone(DEFAULT_PRODUCTOS);
let pedidos = [];
let pagos = [];
let isAdmin = false;
let currentPaymentPedidoId = null;
let backendUrl = ''; // optional, can be configured in UI if you add an input

/* ====== Utils ====== */
const $ = id => document.getElementById(id);
const money = n => `$${(Number(n)||0).toLocaleString('es-CL')}`;
const nowISO = () => new Date().toISOString();
const normPhone = s => (s||'').replace(/\s|-/g,'').trim();
function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function notify(msg, time=3000){ const el = $('notification'); const textEl = $('notification-text'); if(textEl) textEl.textContent = msg; else el.textContent = msg; el.style.display = 'block'; setTimeout(()=> el.style.display = 'none', time); }

/* ====== Persistence ====== */
function saveAll(){
  localStorage.setItem('productos', JSON.stringify(productos));
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  localStorage.setItem('pagos', JSON.stringify(pagos));
  localStorage.setItem('backendUrl', backendUrl || '');
  localStorage.setItem('isAdmin', isAdmin ? '1' : '');
}
function loadAll(){
  try{
    const pr = localStorage.getItem('productos');
    const p = localStorage.getItem('pedidos');
    const pay = localStorage.getItem('pagos');
    const bu = localStorage.getItem('backendUrl');
    const adm = localStorage.getItem('isAdmin');
    if(pr) productos = {...DEFAULT_PRODUCTOS, ...JSON.parse(pr)};
    if(p) pedidos = JSON.parse(p);
    if(pay) pagos = JSON.parse(pay);
    if(bu) backendUrl = bu;
    isAdmin = !!adm;
  } catch(e){
    console.error('loadAll error', e);
  }
  productos.paltas = { ...DEFAULT_PRODUCTOS.paltas, ...(productos.paltas || {}) };
  productos.champi = { ...DEFAULT_PRODUCTOS.champi, ...(productos.champi || {}) };
  productos.frutillas = { ...DEFAULT_PRODUCTOS.frutillas, ...(productos.frutillas || {}) };
}

/* ====== Calculation helpers ====== */
function calcTotalFromItems(items){
  let total = 0;
  // paltas
  if(items.paltas && Number(items.paltas.qty)){
    const q = Number(items.paltas.qty)||0;
    const u = items.paltas.unit;
    if(u === 'kg') total += q * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
    else if(u === 'saco') total += q * ((productos.paltas.sacoKg||25) * (productos.paltas.precio||DEFAULT_PRODUCTOS.paltas.precio));
    else if(u === 'g') total += (q/1000) * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
    else total += q * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
  }
  // champi
  if(items.champi && Number(items.champi.qty)){
    const q = Number(items.champi.qty)||0;
    const u = items.champi.unit;
    if(u === 'caja') total += q * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else if(u === 'g') total += (q / (productos.champi.packGramos || DEFAULT_PRODUCTOS.champi.packGramos)) * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else if(u === 'kg') total += ((q*1000) / (productos.champi.packGramos || DEFAULT_PRODUCTOS.champi.packGramos)) * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else total += q * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
  }
  // frutillas
  if(items.frutillas && Number(items.frutillas.qty)){
    const q = Number(items.frutillas.qty)||0;
    const u = items.frutillas.unit;
    const bloque = productos.frutillas.bloqueGramos || DEFAULT_PRODUCTOS.frutillas.bloqueGramos;
    if(u === 'g') total += (q / bloque) * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
    else if(u === 'kg') total += ((q*1000) / bloque) * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
    else total += q * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
  }
  return Math.round(total);
}

/* ====== Order creation & payments ====== */
function crearPedido({ nombre, telefono, items, comentarios, creadoPorAdmin=false, paymentMethod='' }){
  const total = calcTotalFromItems(items);
  const pedido = {
    id: String(Date.now()) + Math.random().toString(36).slice(2,8),
    nombre: nombre || '',
    telefono: telefono || '',
    items,
    total,
    estadoPago: 'pendiente',
    fecha: nowISO(),
    comentarios: comentarios || '',
    deudaPendiente: total,
    pagos: [],
    creadoPorAdmin,
    paymentMethod
  };
  pedidos.unshift(pedido);
  saveAll();
  renderAll();
  return pedido;
}

function registrarPago(pedidoId, { monto, metodo, notas, fecha }){
  const pedido = pedidos.find(p => p.id === pedidoId);
  if(!pedido) return false;
  const pago = { id: String(Date.now()) + Math.random().toString(36).slice(2,8), pedidoId, monto: Number(monto)||0, metodo: metodo || 'efectivo', notas: notas || '', fecha: fecha || nowISO() };
  pagos.unshift(pago);
  pedido.pagos = pedido.pagos || [];
  pedido.pagos.push(pago);
  pedido.deudaPendiente = Math.max(0, Number(pedido.deudaPendiente || pedido.total) - Number(pago.monto || 0));
  if(pedido.deudaPendiente <= 0) pedido.estadoPago = 'pagado';
  else if(pedido.deudaPendiente < pedido.total) pedido.estadoPago = 'parcial';
  saveAll();
  renderAll();
  return pago;
}
function marcarTodoPagado(pedidoId){
  const pedido = pedidos.find(p => p.id === pedidoId);
  if(!pedido) return false;
  const monto = Number(pedido.deudaPendiente || pedido.total);
  if(monto <= 0) return false;
  return registrarPago(pedidoId, { monto, metodo: 'transferencia', notas: 'Marcado pagado por admin', fecha: nowISO() });
}

/* ====== Rendering UI ====== */

/* Product grid (client) shows all products (no stock display) and the configured unit */
function renderProductGrid(){
  const grid = $('product-grid'); grid.innerHTML = '';
  Object.keys(productos).forEach(key => {
    const p = productos[key];
    // Show all products regardless of "disponible" if admin wants; the user requested to have products appear (they chose earlier)
    const card = document.createElement('div'); card.className = 'product-card';
    const step = (p.baseUnit === 'g') ? 100 : 1;
    card.innerHTML = `
      <div class="product-name">${escapeHTML(p.nombre)}</div>
      <div class="product-unit">Unidad: <strong>${escapeHTML(p.baseUnit)}</strong> ‚Ä¢ Precio venta: <strong>${money(p.precio)}</strong></div>
      <div class="qty-row">
        <input type="number" min="0" step="${step}" value="${p.baseUnit === 'kg' ? 1 : 0}" data-product="${escapeHTML(key)}" class="client-qty" aria-label="Cantidad ${escapeHTML(p.nombre)}">
      </div>
    `;
    grid.appendChild(card);
  });
}

/* Orders table (admin) */
function renderOrders(filterText = '', paymentFilter = 'all'){
  const tbody = $('orders-body'); tbody.innerHTML = '';
  const ft = (filterText || '').toLowerCase();
  pedidos.forEach(p => {
    if(ft){
      const found = (p.nombre || '').toLowerCase().includes(ft) || (p.telefono || '').toLowerCase().includes(ft);
      if(!found) return;
    }
    if(paymentFilter && paymentFilter !== 'all'){
      if(paymentFilter === 'moroso'){
        const dias = (Date.now() - new Date(p.fecha).getTime()) / (1000*60*60*24);
        if(!(p.deudaPendiente > 0 && dias > 30)) return;
      } else {
        if(p.estadoPago !== paymentFilter) return;
      }
    }

    const itemsLines = [];
    if(p.items.paltas && Number(p.items.paltas.qty)) itemsLines.push(`${p.items.paltas.qty} ${p.items.paltas.unit} ${escapeHTML(productos.paltas.nombre)}`);
    if(p.items.champi && Number(p.items.champi.qty)) itemsLines.push(`${p.items.champi.qty} ${p.items.champi.unit} ${escapeHTML(productos.champi.nombre)}`);
    if(p.items.frutillas && Number(p.items.frutillas.qty)) itemsLines.push(`${p.items.frutillas.qty} ${p.items.frutillas.unit} ${escapeHTML(productos.frutillas.nombre)}`);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${escapeHTML(p.nombre)}</strong></td>
      <td>${escapeHTML(p.telefono)}</td>
      <td class="orders-products">${itemsLines.join('<br>')}</td>
      <td>${escapeHTML(p.comentarios || '')}</td>
      <td>${money(p.total)}</td>
      <td><strong>${escapeHTML(p.estadoPago.toUpperCase())}</strong><div class="muted small">Pendiente: ${money(p.deudaPendiente || 0)}</div></td>
      <td>${new Date(p.fecha).toLocaleString()}</td>
      <td class="actions" style="text-align:right">
        <div class="order-actions">
          <button class="icon-btn icon-pay" data-action="open-pay" data-id="${p.id}" title="Registrar pago"><i class="fas fa-money-bill-wave"></i></button>
          <button class="icon-btn icon-view" data-action="view" data-id="${p.id}" title="Ver pedido"><i class="fas fa-eye"></i></button>
          <button class="icon-btn icon-delete" data-action="delete" data-id="${p.id}" title="Eliminar pedido"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ====== Delegated event handling for table actions ====== */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  if(action === 'open-pay') {
    openPaymentModal(id);
  } else if(action === 'view') {
    viewPedidoDetails(id);
  } else if(action === 'delete') {
    if(confirm('Eliminar pedido? Esta acci√≥n es irreversible.')) {
      pedidos = pedidos.filter(pp => pp.id !== id);
      saveAll();
      renderAll();
      notify('Pedido eliminado');
    }
  }
});

/* ====== View details (simple) ====== */
function viewPedidoDetails(id){
  const p = pedidos.find(x => x.id === id);
  if(!p) return notify('Pedido no encontrado', 2500);
  let text = `Pedido: ${p.nombre}\nTel: ${p.telefono}\nFecha: ${new Date(p.fecha).toLocaleString()}\nProductos:\n`;
  if(p.items.paltas && p.items.paltas.qty) text += ` - ${p.items.paltas.qty} ${p.items.paltas.unit} Paltas\n`;
  if(p.items.champi && p.items.champi.qty) text += ` - ${p.items.champi.qty} ${p.items.champi.unit} Champi√±ones\n`;
  if(p.items.frutillas && p.items.frutillas.qty) text += ` - ${p.items.frutillas.qty} ${p.items.frutillas.unit} Frutillas\n`;
  text += `Total: ${money(p.total)}\nPendiente: ${money(p.deudaPendiente)}\nComentarios: ${p.comentarios || '-'}`;
  alert(text);
}

/* ====== Payment modal (admin) ====== */
function openPaymentModal(pedidoId){
  const p = pedidos.find(x => x.id === pedidoId);
  if(!p) return notify('Pedido no encontrado', 2500);
  currentPaymentPedidoId = pedidoId;
  $('payment-client-info').textContent = `${p.nombre} (${p.telefono}) ‚Äî ${new Date(p.fecha).toLocaleString()}`;
  $('payment-amount').value = Math.min(p.deudaPendiente || p.total || 0, p.deudaPendiente || p.total || 0);
  $('payment-notes').value = '';
  $('payment-history-container').style.display = 'none';
  renderPaymentHistoryForPedido(pedidoId);
  showModal('payment-modal');
}
function renderPaymentHistoryForPedido(pedidoId){
  const p = pedidos.find(x => x.id === pedidoId);
  const cont = $('modal-payment-history');
  cont.innerHTML = '';
  if(!p || !p.pagos || p.pagos.length === 0){
    cont.textContent = 'No hay pagos registrados';
    return;
  }
  p.pagos.slice().reverse().forEach(pa => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.padding = '6px 0';
    div.innerHTML = `<div>${new Date(pa.fecha).toLocaleString()} <span class="muted small">(${escapeHTML(pa.metodo)})</span></div><div style="font-weight:700">${money(pa.monto)}</div>`;
    cont.appendChild(div);
  });
}

/* ====== Modal helpers ====== */
function showModal(id){ const el = $(id); if(!el) return; el.classList.add('show'); el.style.display = 'flex'; }
function hideModal(id){ const el = $(id); if(!el) return; el.classList.remove('show'); el.style.display = 'none'; }

/* ====== Product Admin UI ====== */
function renderProductsAdmin(){
  const container = $('products-admin'); container.innerHTML = '';
  Object.keys(productos).forEach(k => {
    const p = productos[k];
    const row = document.createElement('div'); row.className = 'prod-admin-row';
    row.innerHTML = `
      <input id="cfg-${k}-name" value="${escapeHTML(p.nombre)}">
      <input id="cfg-${k}-price" type="number" value="${p.precio}">
      <select id="cfg-${k}-baseunit">
        <option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option>
      </select>
      <select id="cfg-${k}-avail" class="avail">
        <option value="true">Disponible</option><option value="false">No</option>
      </select>
    `;
    container.appendChild(row);
    $(`cfg-${k}-baseunit`).value = p.baseUnit || 'kg';
    $(`cfg-${k}-avail`).value = p.disponible ? 'true' : 'false';
  });
}

/* ====== Event wiring & app init ====== */
function setupListeners(){
  // Client: Enviar pedido -> open summary modal
  $('enviar-pedido').addEventListener('click', () => {
    const nombre = $('nombre').value.trim();
    const telefono = $('telefono').value.trim();
    if(!nombre || !telefono) return alert('Nombre y tel√©fono son requeridos');
    const items = {
      paltas: { qty: 0, unit: productos.paltas.baseUnit },
      champi: { qty: 0, unit: productos.champi.baseUnit },
      frutillas: { qty: 0, unit: productos.frutillas.baseUnit }
    };
    document.querySelectorAll('.client-qty').forEach(input => {
      const key = input.getAttribute('data-product');
      const v = Number(input.value) || 0;
      if(v > 0) items[key] = { qty: v, unit: productos[key].baseUnit };
    });
    // remove zeros:
    const selectedItems = {};
    Object.keys(items).forEach(k => { if(items[k].qty && items[k].qty > 0) selectedItems[k] = items[k]; });

    if(Object.keys(selectedItems).length === 0) return alert('Selecciona al menos un producto');

    // Build summary
    const container = $('summary-items'); container.innerHTML = '';
    Object.keys(selectedItems).forEach(k => {
      const p = productos[k];
      const subtotal = calcTotalFromItems({ [k]: selectedItems[k] });
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.padding = '6px 0';
      row.innerHTML = `<div>${selectedItems[k].qty} ${selectedItems[k].unit} ${escapeHTML(p.nombre)}</div><div style="font-weight:800">${money(subtotal)}</div>`;
      container.appendChild(row);
    });
    if($('comentarios').value.trim()){
      const c = document.createElement('div'); c.className = 'muted small'; c.style.marginTop = '8px'; c.textContent = 'Comentarios / Despacho: ' + $('comentarios').value.trim(); container.appendChild(c);
    }
    const total = calcTotalFromItems(Object.assign({}, selectedItems));
    $('summary-total').textContent = money(total);
    $('summary-payment-method').value = 'efectivo';
    $('summary-transfer-details').style.display = 'none';
    showModal('order-summary-modal');

    // Rewire modal buttons safely by cloning nodes to avoid doubling listeners
    const confirmBtn = $('confirm-order'); const confirmNew = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(confirmNew, confirmBtn);
    const rejectBtn = $('reject-order'); const rejectNew = rejectBtn.cloneNode(true); rejectBtn.parentNode.replaceChild(rejectNew, rejectBtn);
    const methodSel = $('summary-payment-method'); const methodNew = methodSel.cloneNode(true); methodSel.parentNode.replaceChild(methodNew, methodSel);

    methodNew.addEventListener('change', () => {
      if(methodNew.value === 'transferencia') $('summary-transfer-details').style.display = 'block';
      else $('summary-transfer-details').style.display = 'none';
    });

    confirmNew.addEventListener('click', () => {
      // create order
      crearPedido({ nombre, telefono, items: selectedItems, comentarios: $('comentarios').value.trim(), creadoPorAdmin: false, paymentMethod: methodNew.value });
      hideModal('order-summary-modal');
      notify('Gracias por tu compra. Pedido registrado.');
      // reset client inputs
      document.querySelectorAll('.client-qty').forEach(i => { if(i.getAttribute('data-product') === 'paltas') i.value = 1; else i.value = 0; });
      $('nombre').value = ''; $('telefono').value = ''; $('comentarios').value = '';
    });

    rejectNew.addEventListener('click', () => hideModal('order-summary-modal'));
  });

  // Admin login modal wiring
  $('admin-login-link').addEventListener('click', () => showModal('login-modal'));
  $('close-login').addEventListener('click', () => hideModal('login-modal'));
  $('cancel-login').addEventListener('click', () => hideModal('login-modal'));
  $('login-btn').addEventListener('click', () => {
    const email = $('admin-email').value.trim();
    const pass = $('admin-password').value;
    if(email === 'admin@valledor.com' && pass === 'admin123'){
      isAdmin = true; localStorage.setItem('isAdmin','1');
      hideModal('login-modal'); $('admin-email').value = ''; $('admin-password').value = '';
      const adminContainer = $('admin-container');
      adminContainer.style.display = 'block';
      setTimeout(() => { adminContainer.style.opacity = '1'; }, 50);
      renderAll();
      notify('Acceso administrador concedido');
    } else {
      $('login-error').style.display = 'block'; setTimeout(()=> {$('login-error').style.display = 'none';}, 3000);
    }
  });

  // Admin panel buttons
  $('logout-btn').addEventListener('click', () => {
    const adminContainer = $('admin-container');
    adminContainer.style.opacity = '0';
    setTimeout(() => {
      isAdmin = false; 
      localStorage.removeItem('isAdmin'); 
      adminContainer.style.display = 'none';
      notify('Sesi√≥n cerrada');
    }, 300);
  });
  $('refresh-btn').addEventListener('click', () => { renderAll(); notify('Vista actualizada'); });
  $('export-btn').addEventListener('click', () => {
    const rows = buildOrdersCSV();
    exportCSV('pedidos.csv', rows);
    notify('CSV exportado');
  });

  // Add manual order (opens small modal)
  $('add-order-btn').addEventListener('click', () => {
    if(!isAdmin) return notify('Debes iniciar sesi√≥n como admin', 2000);
    // Build inline modal for adding order manually
    const wrapper = document.createElement('div'); wrapper.className = 'modal show'; wrapper.style.display = 'flex';
    const box = document.createElement('div'); box.className = 'modal-box';
    box.innerHTML = `<span class="close-modal tmp-close">&times;</span><h3>Agregar pedido (admin)</h3>
      <div style="display:flex;gap:8px;margin-top:8px"><input id="tmp-name" placeholder="Nombre" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px"><input id="tmp-tel" placeholder="Tel√©fono" style="width:160px;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
      <div id="tmp-products" style="margin-top:10px"></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button id="tmp-create" class="btn">Crear</button><button id="tmp-cancel" class="btn gray">Cancelar</button></div>`;
    wrapper.appendChild(box); document.body.appendChild(wrapper);
    box.querySelector('.tmp-close').addEventListener('click', ()=> wrapper.remove());
    box.querySelector('#tmp-cancel').addEventListener('click', ()=> wrapper.remove());
    const tp = box.querySelector('#tmp-products');
    Object.keys(productos).forEach(k => {
      const p = productos[k];
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.marginTop = '8px';
      row.innerHTML = `<div style="width:160px"><strong>${escapeHTML(p.nombre)}</strong></div>
        <select id="tmp-${k}-unit" style="padding:8px;border-radius:6px;border:1px solid #ddd"><option value="${p.baseUnit}">${p.baseUnit}</option><option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option></select>
        <input id="tmp-${k}-qty" type="number" min="0" step="1" placeholder="Cantidad" style="width:120px;padding:8px;border:1px solid #ddd;border-radius:6px">`;
      tp.appendChild(row);
    });
    box.querySelector('#tmp-create').addEventListener('click', () => {
      const nombre = box.querySelector('#tmp-name').value.trim(); const telefono = box.querySelector('#tmp-tel').value.trim();
      if(!nombre || !telefono) return alert('Nombre y tel√©fono requeridos');
      const items = {};
      Object.keys(productos).forEach(k => {
        const q = Number(box.querySelector(`#tmp-${k}-qty`).value) || 0;
        const u = box.querySelector(`#tmp-${k}-unit`).value || productos[k].baseUnit;
        if(q > 0) items[k] = { qty: q, unit: u };
      });
      if(Object.keys(items).length === 0) return alert('A√±ade al menos un producto');
      crearPedido({ nombre, telefono, items, comentarios: 'Creado por admin', creadoPorAdmin: true });
      wrapper.remove();
      notify('Pedido creado (admin)');
    });
  });

  // Payment modal controls
  $('close-payment').addEventListener('click', () => hideModal('payment-modal'));
  $('register-payment').addEventListener('click', () => {
    if(!currentPaymentPedidoId) return notify('No hay pedido seleccionado', 1600);
    const monto = Number($('payment-amount').value) || 0;
    const metodo = $('payment-method').value;
    const notas = $('payment-notes').value || '';
    if(monto <= 0) return alert('Ingresa un monto v√°lido');
    registrarPago(currentPaymentPedidoId, { monto, metodo, notas, fecha: nowISO() });
    renderPaymentHistoryForPedido(currentPaymentPedidoId);
    notify('Pago registrado');
  });
  $('mark-as-paid').addEventListener('click', () => {
    if(!currentPaymentPedidoId) return notify('No hay pedido seleccionado', 1600);
    if(!confirm('Marcar todo como pagado?')) return;
    marcarTodoPagado(currentPaymentPedidoId);
    renderPaymentHistoryForPedido(currentPaymentPedidoId);
    notify('Pedido marcado como pagado');
  });
  $('toggle-payment-history').addEventListener('click', () => {
    const el = $('payment-history-container');
    if(el.style.display === 'block') el.style.display = 'none';
    else { el.style.display = 'block'; if(currentPaymentPedidoId) renderPaymentHistoryForPedido(currentPaymentPedidoId); }
  });

  // Save/Reset products
  $('save-products-btn').addEventListener('click', () => {
    Object.keys(productos).forEach(k => {
      productos[k].nombre = $(`cfg-${k}-name`).value || productos[k].nombre;
      productos[k].precio = Number($(`cfg-${k}-price`).value) || productos[k].precio;
      productos[k].baseUnit = $(`cfg-${k}-baseunit`).value || productos[k].baseUnit;
      productos[k].disponible = $(`cfg-${k}-avail`).value === 'true';
    });
    saveAll(); renderAll(); notify('Productos guardados');
  });
  $('reset-products-btn').addEventListener('click', () => {
    if(!confirm('Restablecer productos a valores por defecto?')) return;
    productos = structuredClone(DEFAULT_PRODUCTOS);
    saveAll(); renderAll(); notify('Productos restaurados');
  });

  // Search/filter events
  $('search-input').addEventListener('input', e => renderOrders(e.target.value || '', $('payment-filter').value || 'all'));
  $('payment-filter').addEventListener('change', () => renderOrders($('search-input').value || '', $('payment-filter').value || 'all'));
}

/* ====== CSV export helpers ====== */
function buildOrdersCSV(){
  const header = ['ID','Nombre','Telefono','Fecha','Productos','Comentarios','Total','Estado','DeudaPendiente','PaymentMethod'];
  const rows = [header];
  pedidos.forEach(p => {
    const items = [];
    if(p.items.paltas && p.items.paltas.qty) items.push(`${p.items.paltas.qty} ${p.items.paltas.unit} Paltas`);
    if(p.items.champi && p.items.champi.qty) items.push(`${p.items.champi.qty} ${p.items.champi.unit} Champi√±ones`);
    if(p.items.frutillas && p.items.frutillas.qty) items.push(`${p.items.frutillas.qty} ${p.items.frutillas.unit} Frutillas`);
    rows.push([p.id, p.nombre, p.telefono, p.fecha, items.join(' | '), p.comentarios || '', p.total, p.estadoPago, p.deudaPendiente, p.paymentMethod || '']);
  });
  return rows;
}
function exportCSV(filename, rows){
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ====== Initial load & render ====== */
(function init(){
  loadAll();
  if(localStorage.getItem('isAdmin')){
    isAdmin = true;
    const adminContainer = $('admin-container');
    adminContainer.style.display = 'block';
    setTimeout(() => { adminContainer.style.opacity = '1'; }, 50);
  } else {
    $('admin-container').style.display = 'none';
  }
  setupListeners();
  renderAll();

  // default paltas qty to 1 for convenience after render
  setTimeout(()=> { document.querySelectorAll('.client-qty').forEach(i => { if(i && i.getAttribute('data-product') === 'paltas') i.value = 1; }); }, 200);
})();

/* ====== renderAll wraps product/admin/ orders ====== */
function renderAll(){
  renderProductGrid();
  renderProductsAdmin();
  renderOrders($('search-input')?.value || '', $('payment-filter')?.value || 'all');
}

/* ====== Render products admin (build inputs) ====== */
function renderProductsAdmin(){
  const container = $('products-admin'); container.innerHTML = '';
  Object.keys(productos).forEach(k => {
    const p = productos[k];
    const row = document.createElement('div'); row.className = 'prod-admin-row';
    row.innerHTML = `
      <input id="cfg-${k}-name" value="${escapeHTML(p.nombre)}">
      <input id="cfg-${k}-price" type="number" value="${p.precio}">
      <select id="cfg-${k}-baseunit">
        <option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option>
      </select>
      <select id="cfg-${k}-avail" class="avail">
        <option value="true">Disponible</option><option value="false">No</option>
      </select>
    `;
    container.appendChild(row);
    $(`cfg-${k}-baseunit`).value = p.baseUnit || 'kg';
    $(`cfg-${k}-avail`).value = p.disponible ? 'true' : 'false';
  });
}

/* ====== Safe helper for cloning nodes (to avoid duplicate listeners) ====== */
function safeReplace(node){
  const clone = node.cloneNode(true);
  node.parentNode.replaceChild(clone, node);
  return clone;
}
</script>
</body>
</html>
