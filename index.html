<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compras Grupales - Lazo Mercado</title>

  <!-- Fuentes e íconos -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary:#2e7d32;
      --primary-strong:#1b5e20;
      --bg:#f6f4f0;
      --card:#fff;
      --muted:#666666;
      --danger:#d32f2f;
      --success:#388e3c;
      --glass: rgba(255,255,255,0.6);
    }
    *{box-sizing:border-box}
    body{font-family:'Poppins',sans-serif;background:var(--bg);color:#222;margin:0;line-height:1.35}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-strong));color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand h1{font-size:1.1rem;margin:0}
    .brand p{margin:0;font-size:.9rem;opacity:.95}
    .container{max-width:1120px;margin:18px auto;padding:12px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 8px 22px rgba(0,0,0,.06)}
    .grid{display:grid;gap:12px}
    /* PRODUCT GRID (CLIENT) */
    .product-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
    .product-card{border:1px solid #eee;border-radius:10px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:8px}
    .product-name{font-weight:700;font-size:1.02rem}
    .product-unit{font-size:.9rem;color:var(--muted)}
    .qty-row{display:flex;gap:8px;align-items:center;margin-top:6px}
    .qty-row input{flex:1;padding:10px;border-radius:8px;border:1px solid #ddd}
    /* BUTTONS */
    .btn{background:linear-gradient(90deg,var(--primary),var(--primary-strong));color:#fff;border:0;padding:10px 14px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.gray{background:linear-gradient(90deg,#607d8b,#455a64)}
    .btn.danger{background:linear-gradient(90deg,#d32f2f,#b71c1c)}
    .btn.small{padding:8px 10px;font-size:.92rem}
    .muted{color:var(--muted)}
    .small{font-size:.88rem;color:var(--muted)}
    /* ADMIN */
    .admin-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:10px}
    .admin-controls{display:flex;gap:8px;flex-wrap:wrap}
    .orders-table{width:100%;border-collapse:collapse;margin-top:12px;font-size:.95rem}
    .orders-table th{background:rgba(46,125,50,.08);padding:10px;text-align:left;border-bottom:1px solid #e9f3ea}
    .orders-table td{padding:10px;border-bottom:1px solid #f2f2f2;vertical-align:middle}
    .orders-products{color:var(--muted);font-size:.92rem;line-height:1.25}
    .order-actions{display:flex;gap:8px;justify-content:flex-end}
    .icon-btn{width:40px;height:40px;border-radius:8px;border:0;color:#fff;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,.06)}
    .icon-pay{background:linear-gradient(90deg,#2196f3,#1976d2)}
    .icon-view{background:linear-gradient(90deg,#607d8b,#455a64)}
    .icon-delete{background:linear-gradient(90deg,#d32f2f,#b71c1c)}
    td.actions{width:140px;max-width:140px}
    /* MODALS */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9999;align-items:center;justify-content:center;padding:12px}
    .modal.show{display:flex}
    .modal-box{width:100%;max-width:760px;background:#fff;border-radius:10px;padding:16px;max-height:92vh;overflow:auto;position:relative}
    .close-modal{position:absolute;right:14px;top:10px;font-size:18px;cursor:pointer}
    /* Admin product row */
    .prod-admin-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .prod-admin-row input, .prod-admin-row select{width:calc(100% / 4 - 8px);min-width:120px;padding:8px;border-radius:8px;border:1px solid #ddd}
    .prod-admin-row .avail{width:120px}
    /* FINANZAS */
    .fin-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .list{max-height:300px;overflow:auto;padding:8px;border-radius:8px;border:1px solid #eee}
    .list-item{padding:8px;border-bottom:1px solid #f2f2f2;display:flex;justify-content:space-between}
    .badge{display:inline-block;padding:4px 8px;border-radius:6px;background:#f1f1f1}
    @media (max-width:720px){ .prod-admin-row input, .prod-admin-row select{width:100%} .fin-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <i class="fas fa-shopping-basket" style="font-size:20px"></i>
    <div>
      <h1>Compras Grupales — Lazo Mercado</h1>
      <p class="small muted">Control de pedidos y pagos</p>
    </div>
  </div>
  <div>
    <button id="admin-login-link" class="btn"><i class="fas fa-user-shield" style="margin-right:8px"></i> Administrador</button>
  </div>
</header>

<div class="container">
  <!-- CLIENT FORM -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;color:var(--primary)"><i class="fas fa-cart-plus"></i> Realiza tu pedido</h2>

    <div class="grid">
      <div>
        <label><strong>Nombre</strong></label>
        <input id="nombre" type="text" placeholder="Juan Pérez">
      </div>

      <div>
        <label><strong>Teléfono</strong></label>
        <input id="telefono" type="tel" placeholder="+56912345678">
      </div>

      <div>
        <label><strong>Productos</strong></label>
        <div id="product-grid" class="product-grid"></div>
      </div>

      <div>
        <label><strong>Comentarios / Destino despacho</strong></label>
        <textarea id="comentarios" rows="2" placeholder="Ej: departamento, dirección, referencia"></textarea>
      </div>

      <div>
        <button id="enviar-pedido" class="btn"><i class="fas fa-paper-plane" style="margin-right:8px"></i> Enviar pedido</button>
      </div>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div id="admin-container" class="card" style="display:none;margin-top:14px;">
    <div class="admin-header">
      <div>
        <h3 style="margin:0">Panel Administrador</h3>
        <div class="small muted">Gestiona productos y pedidos</div>
      </div>
      <div class="admin-controls">
        <button id="add-order-btn" class="btn small">Agregar pedido</button>
        <button id="export-btn" class="btn small gray">Exportar CSV</button>
        <button id="refresh-btn" class="btn small" style="background:linear-gradient(90deg,#388e3c,#1b5e20)">Actualizar</button>
        <button id="logout-btn" class="btn small danger">Salir</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <input id="search-input" placeholder="Buscar por nombre o teléfono..." style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd">
      <select id="payment-filter" style="width:200px;padding:10px;border-radius:8px;border:1px solid #ddd">
        <option value="all">Todos</option>
        <option value="pendiente">Pendientes</option>
        <option value="parcial">Parciales</option>
        <option value="pagado">Pagados</option>
        <option value="moroso">Morosos (+30 días)</option>
      </select>
    </div>

    <table class="orders-table" aria-describedby="orders">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Teléfono</th>
          <th>Productos</th>
          <th>Comentarios (Despacho)</th>
          <th>Total</th>
          <th>Pago</th>
          <th>Fecha</th>
          <th class="actions">Acciones</th>
        </tr>
      </thead>
      <tbody id="orders-body"></tbody>
    </table>

    <!-- PRODUCTS ADMIN -->
    <div style="margin-top:12px;">
      <div class="card">
        <h4 style="margin:0">Configuración de productos (Administrador)</h4>
        <div id="products-admin" style="margin-top:10px"></div>
        <div style="margin-top:10px;display:flex;gap:8px;">
          <button id="save-products-btn" class="btn">Guardar productos</button>
          <button id="reset-products-btn" class="btn danger">Reset</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- ORDER SUMMARY MODAL -->
<div id="order-summary-modal" class="modal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-modal" id="close-order-summary">&times;</span>
    <h2><i class="fas fa-receipt"></i> Resumen de tu pedido</h2>
    <div id="summary-items" style="margin-top:10px"></div>

    <div style="display:flex;gap:12px;align-items:center;margin-top:12px;">
      <div style="flex:1">
        <label><strong>Método de pago</strong></label>
        <select id="summary-payment-method" style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd">
          <option value="efectivo">Efectivo (al recibir)</option>
          <option value="transferencia">Transferencia / Mercado Pago</option>
        </select>
      </div>

      <div style="display:flex;gap:8px;">
        <button id="confirm-order" class="btn">Aceptar</button>
        <button id="reject-order" class="btn gray">Rechazar</button>
      </div>
    </div>

    <div id="summary-transfer-details" style="display:none;margin-top:12px;">
      <div class="card">
        <strong>Datos para transferencia / Mercado Pago</strong>
        <div class="muted small" style="margin-top:6px;">Sólo si seleccionas transferencia</div>
        <div style="margin-top:8px;font-weight:700">
          Álvaro Aaron Lazo Reyes<br>
          RUT: 168400896<br>
          Cuenta Vista - Número de cuenta: <b>1014726096</b><br>
          Email Mercado Pago: <b>alvarolazo18@gmail.com</b>
        </div>
      </div>
    </div>

    <div style="text-align:right;margin-top:12px;">Total: <span id="summary-total" style="font-weight:800;color:var(--primary)">$0</span></div>
  </div>
</div>

<!-- PAYMENT MODAL (ADMIN) -->
<div id="payment-modal" class="modal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-modal" id="close-payment">&times;</span>
    <h2><i class="fas fa-money-bill-wave"></i> Registrar pago</h2>
    <div id="payment-client-info" class="muted small" style="margin-top:6px"></div>

    <div style="margin-top:8px">
      <label>Monto</label>
      <input id="payment-amount" type="number" min="0" step="100">
    </div>
    <div style="margin-top:8px">
      <label>Método</label>
      <select id="payment-method">
        <option value="efectivo">Efectivo</option>
        <option value="transferencia">Transferencia</option>
      </select>
    </div>
    <div style="margin-top:8px">
      <label>Notas</label>
      <textarea id="payment-notes" rows="2"></textarea>
    </div>

    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="register-payment" class="btn">Registrar</button>
      <button id="mark-as-paid" class="btn" style="background:linear-gradient(90deg,#388e3c,#1b5e20)">Marcar pagado</button>
      <button id="toggle-payment-history" class="btn gray">Historial</button>
    </div>

    <div id="payment-history-container" style="display:none;margin-top:12px;">
      <div id="modal-payment-history" class="list"></div>
    </div>
  </div>
</div>

<!-- LOGIN MODAL -->
<div id="login-modal" class="modal">
  <div class="modal-box">
    <span class="close-modal" id="close-login">&times;</span>
    <h2>Acceso Administrador</h2>
    <div style="margin-top:8px">
      <label>Correo</label>
      <input id="admin-email" type="email" placeholder="admin@valledor.com">
    </div>
    <div style="margin-top:8px">
      <label>Contraseña</label>
      <input id="admin-password" type="password" placeholder="admin123">
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button id="login-btn" class="btn">Iniciar sesión</button>
      <button id="cancel-login" class="btn gray">Cancelar</button>
    </div>
    <div id="login-error" class="muted" style="color:var(--danger);display:none;margin-top:8px;">Credenciales incorrectas</div>
  </div>
</div>

<!-- Notification -->
<div id="notification" style="position:fixed;right:16px;top:16px;background:var(--primary);color:#fff;padding:8px 12px;border-radius:8px;display:none;z-index:9999"></div>

<script>
/*
  Consolidated index.html implementing:
  - Admin product config: choose base selling unit (kg / caja / g / saco)
  - Client view: shows all products (regardless of stock) with chosen unit, user inputs qty
  - On "Enviar pedido": modal summary with 2 payment options (efectivo / transferencia)
    - If transferencia selected, shows Mercado Pago transfer information
    - Confirm creates order saved in localStorage and shows "Gracias por la compra" notification
  - Admin panel: list orders, register payments (modal), export CSV, add manual orders
  - All main buttons wired. No stock is shown to client.
  - Orders are kept in localStorage; optional backend sending can be added later
*/

/* ====== App State & Defaults ====== */
const DEFAULT_PRODUCTOS = {
  paltas: { key:'paltas', nombre:'Paltas', precio:3500, baseUnit:'kg', sacoKg:25, disponible:true },
  champi: { key:'champi', nombre:'Champiñones', precio:2500, baseUnit:'caja', packGramos:250, disponible:true },
  frutillas: { key:'frutillas', nombre:'Frutillas', precio:1200, baseUnit:'g', bloqueGramos:100, disponible:true }
};

let productos = structuredClone(DEFAULT_PRODUCTOS);
let pedidos = [];
let pagos = [];
let isAdmin = false;
let currentPaymentPedidoId = null;
let backendUrl = ''; // optional, can be configured in UI if you add an input

/* ====== Utils ====== */
const $ = id => document.getElementById(id);
const money = n => `$${(Number(n)||0).toLocaleString('es-CL')}`;
const nowISO = () => new Date().toISOString();
const normPhone = s => (s||'').replace(/\s|-/g,'').trim();
function escapeHTML(s=''){ return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function notify(msg, time=3000){ const el = $('notification'); el.textContent = msg; el.style.display = 'block'; setTimeout(()=> el.style.display = 'none', time); }

/* ====== Persistence ====== */
function saveAll(){
  localStorage.setItem('productos', JSON.stringify(productos));
  localStorage.setItem('pedidos', JSON.stringify(pedidos));
  localStorage.setItem('pagos', JSON.stringify(pagos));
  localStorage.setItem('backendUrl', backendUrl || '');
  localStorage.setItem('isAdmin', isAdmin ? '1' : '');
}
function loadAll(){
  try{
    const pr = localStorage.getItem('productos');
    const p = localStorage.getItem('pedidos');
    const pay = localStorage.getItem('pagos');
    const bu = localStorage.getItem('backendUrl');
    const adm = localStorage.getItem('isAdmin');
    if(pr) productos = {...DEFAULT_PRODUCTOS, ...JSON.parse(pr)};
    if(p) pedidos = JSON.parse(p);
    if(pay) pagos = JSON.parse(pay);
    if(bu) backendUrl = bu;
    isAdmin = !!adm;
  } catch(e){
    console.error('loadAll error', e);
  }
  productos.paltas = { ...DEFAULT_PRODUCTOS.paltas, ...(productos.paltas || {}) };
  productos.champi = { ...DEFAULT_PRODUCTOS.champi, ...(productos.champi || {}) };
  productos.frutillas = { ...DEFAULT_PRODUCTOS.frutillas, ...(productos.frutillas || {}) };
}

/* ====== Calculation helpers ====== */
function calcTotalFromItems(items){
  let total = 0;
  // paltas
  if(items.paltas && Number(items.paltas.qty)){
    const q = Number(items.paltas.qty)||0;
    const u = items.paltas.unit;
    if(u === 'kg') total += q * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
    else if(u === 'saco') total += q * ((productos.paltas.sacoKg||25) * (productos.paltas.precio||DEFAULT_PRODUCTOS.paltas.precio));
    else if(u === 'g') total += (q/1000) * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
    else total += q * (productos.paltas.precio || DEFAULT_PRODUCTOS.paltas.precio);
  }
  // champi
  if(items.champi && Number(items.champi.qty)){
    const q = Number(items.champi.qty)||0;
    const u = items.champi.unit;
    if(u === 'caja') total += q * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else if(u === 'g') total += (q / (productos.champi.packGramos || DEFAULT_PRODUCTOS.champi.packGramos)) * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else if(u === 'kg') total += ((q*1000) / (productos.champi.packGramos || DEFAULT_PRODUCTOS.champi.packGramos)) * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
    else total += q * (productos.champi.precio || DEFAULT_PRODUCTOS.champi.precio);
  }
  // frutillas
  if(items.frutillas && Number(items.frutillas.qty)){
    const q = Number(items.frutillas.qty)||0;
    const u = items.frutillas.unit;
    const bloque = productos.frutillas.bloqueGramos || DEFAULT_PRODUCTOS.frutillas.bloqueGramos;
    if(u === 'g') total += (q / bloque) * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
    else if(u === 'kg') total += ((q*1000) / bloque) * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
    else total += q * (productos.frutillas.precio || DEFAULT_PRODUCTOS.frutillas.precio);
  }
  return Math.round(total);
}

/* ====== Order creation & payments ====== */
function crearPedido({ nombre, telefono, items, comentarios, creadoPorAdmin=false, paymentMethod='' }){
  const total = calcTotalFromItems(items);
  const pedido = {
    id: String(Date.now()) + Math.random().toString(36).slice(2,8),
    nombre: nombre || '',
    telefono: telefono || '',
    items,
    total,
    estadoPago: 'pendiente',
    fecha: nowISO(),
    comentarios: comentarios || '',
    deudaPendiente: total,
    pagos: [],
    creadoPorAdmin,
    paymentMethod
  };
  pedidos.unshift(pedido);
  saveAll();
  renderAll();
  return pedido;
}

function registrarPago(pedidoId, { monto, metodo, notas, fecha }){
  const pedido = pedidos.find(p => p.id === pedidoId);
  if(!pedido) return false;
  const pago = { id: String(Date.now()) + Math.random().toString(36).slice(2,8), pedidoId, monto: Number(monto)||0, metodo: metodo || 'efectivo', notas: notas || '', fecha: fecha || nowISO() };
  pagos.unshift(pago);
  pedido.pagos = pedido.pagos || [];
  pedido.pagos.push(pago);
  pedido.deudaPendiente = Math.max(0, Number(pedido.deudaPendiente || pedido.total) - Number(pago.monto || 0));
  if(pedido.deudaPendiente <= 0) pedido.estadoPago = 'pagado';
  else if(pedido.deudaPendiente < pedido.total) pedido.estadoPago = 'parcial';
  saveAll();
  renderAll();
  return pago;
}
function marcarTodoPagado(pedidoId){
  const pedido = pedidos.find(p => p.id === pedidoId);
  if(!pedido) return false;
  const monto = Number(pedido.deudaPendiente || pedido.total);
  if(monto <= 0) return false;
  return registrarPago(pedidoId, { monto, metodo: 'transferencia', notas: 'Marcado pagado por admin', fecha: nowISO() });
}

/* ====== Rendering UI ====== */

/* Product grid (client) shows all products (no stock display) and the configured unit */
function renderProductGrid(){
  const grid = $('product-grid'); grid.innerHTML = '';
  Object.keys(productos).forEach(key => {
    const p = productos[key];
    // Show all products regardless of "disponible" if admin wants; the user requested to have products appear (they chose earlier)
    const card = document.createElement('div'); card.className = 'product-card';
    const step = (p.baseUnit === 'g') ? 100 : 1;
    card.innerHTML = `
      <div class="product-name">${escapeHTML(p.nombre)}</div>
      <div class="product-unit">Unidad: <strong>${escapeHTML(p.baseUnit)}</strong> • Precio venta: <strong>${money(p.precio)}</strong></div>
      <div class="qty-row">
        <input type="number" min="0" step="${step}" value="${p.baseUnit === 'kg' ? 1 : 0}" data-product="${escapeHTML(key)}" class="client-qty" aria-label="Cantidad ${escapeHTML(p.nombre)}">
      </div>
    `;
    grid.appendChild(card);
  });
}

/* Orders table (admin) */
function renderOrders(filterText = '', paymentFilter = 'all'){
  const tbody = $('orders-body'); tbody.innerHTML = '';
  const ft = (filterText || '').toLowerCase();
  pedidos.forEach(p => {
    if(ft){
      const found = (p.nombre || '').toLowerCase().includes(ft) || (p.telefono || '').toLowerCase().includes(ft);
      if(!found) return;
    }
    if(paymentFilter && paymentFilter !== 'all'){
      if(paymentFilter === 'moroso'){
        const dias = (Date.now() - new Date(p.fecha).getTime()) / (1000*60*60*24);
        if(!(p.deudaPendiente > 0 && dias > 30)) return;
      } else {
        if(p.estadoPago !== paymentFilter) return;
      }
    }

    const itemsLines = [];
    if(p.items.paltas && Number(p.items.paltas.qty)) itemsLines.push(`${p.items.paltas.qty} ${p.items.paltas.unit} ${escapeHTML(productos.paltas.nombre)}`);
    if(p.items.champi && Number(p.items.champi.qty)) itemsLines.push(`${p.items.champi.qty} ${p.items.champi.unit} ${escapeHTML(productos.champi.nombre)}`);
    if(p.items.frutillas && Number(p.items.frutillas.qty)) itemsLines.push(`${p.items.frutillas.qty} ${p.items.frutillas.unit} ${escapeHTML(productos.frutillas.nombre)}`);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${escapeHTML(p.nombre)}</strong></td>
      <td>${escapeHTML(p.telefono)}</td>
      <td class="orders-products">${itemsLines.join('<br>')}</td>
      <td>${escapeHTML(p.comentarios || '')}</td>
      <td>${money(p.total)}</td>
      <td><strong>${escapeHTML(p.estadoPago.toUpperCase())}</strong><div class="muted small">Pendiente: ${money(p.deudaPendiente || 0)}</div></td>
      <td>${new Date(p.fecha).toLocaleString()}</td>
      <td class="actions" style="text-align:right">
        <div class="order-actions">
          <button class="icon-btn icon-pay" data-action="open-pay" data-id="${p.id}" title="Registrar pago"><i class="fas fa-money-bill-wave"></i></button>
          <button class="icon-btn icon-view" data-action="view" data-id="${p.id}" title="Ver pedido"><i class="fas fa-eye"></i></button>
          <button class="icon-btn icon-delete" data-action="delete" data-id="${p.id}" title="Eliminar pedido"><i class="fas fa-trash"></i></button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ====== Delegated event handling for table actions ====== */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-action]');
  if(!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  if(action === 'open-pay') {
    openPaymentModal(id);
  } else if(action === 'view') {
    viewPedidoDetails(id);
  } else if(action === 'delete') {
    if(confirm('Eliminar pedido? Esta acción es irreversible.')) {
      pedidos = pedidos.filter(pp => pp.id !== id);
      saveAll();
      renderAll();
      notify('Pedido eliminado');
    }
  }
});

/* ====== View details (simple) ====== */
function viewPedidoDetails(id){
  const p = pedidos.find(x => x.id === id);
  if(!p) return notify('Pedido no encontrado', 2500);
  let text = `Pedido: ${p.nombre}\nTel: ${p.telefono}\nFecha: ${new Date(p.fecha).toLocaleString()}\nProductos:\n`;
  if(p.items.paltas && p.items.paltas.qty) text += ` - ${p.items.paltas.qty} ${p.items.paltas.unit} Paltas\n`;
  if(p.items.champi && p.items.champi.qty) text += ` - ${p.items.champi.qty} ${p.items.champi.unit} Champiñones\n`;
  if(p.items.frutillas && p.items.frutillas.qty) text += ` - ${p.items.frutillas.qty} ${p.items.frutillas.unit} Frutillas\n`;
  text += `Total: ${money(p.total)}\nPendiente: ${money(p.deudaPendiente)}\nComentarios: ${p.comentarios || '-'}`;
  alert(text);
}

/* ====== Payment modal (admin) ====== */
function openPaymentModal(pedidoId){
  const p = pedidos.find(x => x.id === pedidoId);
  if(!p) return notify('Pedido no encontrado', 2500);
  currentPaymentPedidoId = pedidoId;
  $('payment-client-info').textContent = `${p.nombre} (${p.telefono}) — ${new Date(p.fecha).toLocaleString()}`;
  $('payment-amount').value = Math.min(p.deudaPendiente || p.total || 0, p.deudaPendiente || p.total || 0);
  $('payment-notes').value = '';
  $('payment-history-container').style.display = 'none';
  renderPaymentHistoryForPedido(pedidoId);
  showModal('payment-modal');
}
function renderPaymentHistoryForPedido(pedidoId){
  const p = pedidos.find(x => x.id === pedidoId);
  const cont = $('modal-payment-history');
  cont.innerHTML = '';
  if(!p || !p.pagos || p.pagos.length === 0){
    cont.textContent = 'No hay pagos registrados';
    return;
  }
  p.pagos.slice().reverse().forEach(pa => {
    const div = document.createElement('div');
    div.style.display = 'flex';
    div.style.justifyContent = 'space-between';
    div.style.padding = '6px 0';
    div.innerHTML = `<div>${new Date(pa.fecha).toLocaleString()} <span class="muted small">(${escapeHTML(pa.metodo)})</span></div><div style="font-weight:700">${money(pa.monto)}</div>`;
    cont.appendChild(div);
  });
}

/* ====== Modal helpers ====== */
function showModal(id){ const el = $(id); if(!el) return; el.classList.add('show'); el.style.display = 'flex'; }
function hideModal(id){ const el = $(id); if(!el) return; el.classList.remove('show'); el.style.display = 'none'; }

/* ====== Product Admin UI ====== */
function renderProductsAdmin(){
  const container = $('products-admin'); container.innerHTML = '';
  Object.keys(productos).forEach(k => {
    const p = productos[k];
    const row = document.createElement('div'); row.className = 'prod-admin-row';
    row.innerHTML = `
      <input id="cfg-${k}-name" value="${escapeHTML(p.nombre)}">
      <input id="cfg-${k}-price" type="number" value="${p.precio}">
      <select id="cfg-${k}-baseunit">
        <option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option>
      </select>
      <select id="cfg-${k}-avail" class="avail">
        <option value="true">Disponible</option><option value="false">No</option>
      </select>
    `;
    container.appendChild(row);
    $(`cfg-${k}-baseunit`).value = p.baseUnit || 'kg';
    $(`cfg-${k}-avail`).value = p.disponible ? 'true' : 'false';
  });
}

/* ====== Event wiring & app init ====== */
function setupListeners(){
  // Client: Enviar pedido -> open summary modal
  $('enviar-pedido').addEventListener('click', () => {
    const nombre = $('nombre').value.trim();
    const telefono = $('telefono').value.trim();
    if(!nombre || !telefono) return alert('Nombre y teléfono son requeridos');
    const items = {
      paltas: { qty: 0, unit: productos.paltas.baseUnit },
      champi: { qty: 0, unit: productos.champi.baseUnit },
      frutillas: { qty: 0, unit: productos.frutillas.baseUnit }
    };
    document.querySelectorAll('.client-qty').forEach(input => {
      const key = input.getAttribute('data-product');
      const v = Number(input.value) || 0;
      if(v > 0) items[key] = { qty: v, unit: productos[key].baseUnit };
    });
    // remove zeros:
    const selectedItems = {};
    Object.keys(items).forEach(k => { if(items[k].qty && items[k].qty > 0) selectedItems[k] = items[k]; });

    if(Object.keys(selectedItems).length === 0) return alert('Selecciona al menos un producto');

    // Build summary
    const container = $('summary-items'); container.innerHTML = '';
    Object.keys(selectedItems).forEach(k => {
      const p = productos[k];
      const subtotal = calcTotalFromItems({ [k]: selectedItems[k] });
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.padding = '6px 0';
      row.innerHTML = `<div>${selectedItems[k].qty} ${selectedItems[k].unit} ${escapeHTML(p.nombre)}</div><div style="font-weight:800">${money(subtotal)}</div>`;
      container.appendChild(row);
    });
    if($('comentarios').value.trim()){
      const c = document.createElement('div'); c.className = 'muted small'; c.style.marginTop = '8px'; c.textContent = 'Comentarios / Despacho: ' + $('comentarios').value.trim(); container.appendChild(c);
    }
    const total = calcTotalFromItems(Object.assign({}, selectedItems));
    $('summary-total').textContent = money(total);
    $('summary-payment-method').value = 'efectivo';
    $('summary-transfer-details').style.display = 'none';
    showModal('order-summary-modal');

    // Rewire modal buttons safely by cloning nodes to avoid doubling listeners
    const confirmBtn = $('confirm-order'); const confirmNew = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(confirmNew, confirmBtn);
    const rejectBtn = $('reject-order'); const rejectNew = rejectBtn.cloneNode(true); rejectBtn.parentNode.replaceChild(rejectNew, rejectBtn);
    const methodSel = $('summary-payment-method'); const methodNew = methodSel.cloneNode(true); methodSel.parentNode.replaceChild(methodNew, methodSel);

    methodNew.addEventListener('change', () => {
      if(methodNew.value === 'transferencia') $('summary-transfer-details').style.display = 'block';
      else $('summary-transfer-details').style.display = 'none';
    });

    confirmNew.addEventListener('click', () => {
      // create order
      crearPedido({ nombre, telefono, items: selectedItems, comentarios: $('comentarios').value.trim(), creadoPorAdmin: false, paymentMethod: methodNew.value });
      hideModal('order-summary-modal');
      notify('Gracias por tu compra. Pedido registrado.');
      // reset client inputs
      document.querySelectorAll('.client-qty').forEach(i => { if(i.getAttribute('data-product') === 'paltas') i.value = 1; else i.value = 0; });
      $('nombre').value = ''; $('telefono').value = ''; $('comentarios').value = '';
    });

    rejectNew.addEventListener('click', () => hideModal('order-summary-modal'));
  });

  // Admin login modal wiring
  $('admin-login-link').addEventListener('click', () => showModal('login-modal'));
  $('close-login').addEventListener('click', () => hideModal('login-modal'));
  $('cancel-login').addEventListener('click', () => hideModal('login-modal'));
  $('login-btn').addEventListener('click', () => {
    const email = $('admin-email').value.trim();
    const pass = $('admin-password').value;
    if(email === 'admin@valledor.com' && pass === 'admin123'){
      isAdmin = true; localStorage.setItem('isAdmin','1');
      hideModal('login-modal'); $('admin-email').value = ''; $('admin-password').value = '';
      $('admin-container').style.display = 'block';
      renderAll();
      notify('Acceso administrador concedido');
    } else {
      $('login-error').style.display = 'block'; setTimeout(()=> {$('login-error').style.display = 'none';}, 2000);
    }
  });

  // Admin panel buttons
  $('logout-btn').addEventListener('click', () => {
    isAdmin = false; localStorage.removeItem('isAdmin'); $('admin-container').style.display = 'none'; notify('Sesión cerrada');
  });
  $('refresh-btn').addEventListener('click', () => { renderAll(); notify('Vista actualizada'); });
  $('export-btn').addEventListener('click', () => {
    const rows = buildOrdersCSV();
    exportCSV('pedidos.csv', rows);
    notify('CSV exportado');
  });

  // Add manual order (opens small modal)
  $('add-order-btn').addEventListener('click', () => {
    if(!isAdmin) return notify('Debes iniciar sesión como admin', 2000);
    // Build inline modal for adding order manually
    const wrapper = document.createElement('div'); wrapper.className = 'modal show'; wrapper.style.display = 'flex';
    const box = document.createElement('div'); box.className = 'modal-box';
    box.innerHTML = `<span class="close-modal tmp-close">&times;</span><h3>Agregar pedido (admin)</h3>
      <div style="display:flex;gap:8px;margin-top:8px"><input id="tmp-name" placeholder="Nombre" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:6px"><input id="tmp-tel" placeholder="Teléfono" style="width:160px;padding:8px;border:1px solid #ddd;border-radius:6px"></div>
      <div id="tmp-products" style="margin-top:10px"></div>
      <div style="display:flex;gap:8px;margin-top:10px"><button id="tmp-create" class="btn">Crear</button><button id="tmp-cancel" class="btn gray">Cancelar</button></div>`;
    wrapper.appendChild(box); document.body.appendChild(wrapper);
    box.querySelector('.tmp-close').addEventListener('click', ()=> wrapper.remove());
    box.querySelector('#tmp-cancel').addEventListener('click', ()=> wrapper.remove());
    const tp = box.querySelector('#tmp-products');
    Object.keys(productos).forEach(k => {
      const p = productos[k];
      const row = document.createElement('div'); row.style.display = 'flex'; row.style.gap = '8px'; row.style.marginTop = '8px';
      row.innerHTML = `<div style="width:160px"><strong>${escapeHTML(p.nombre)}</strong></div>
        <select id="tmp-${k}-unit" style="padding:8px;border-radius:6px;border:1px solid #ddd"><option value="${p.baseUnit}">${p.baseUnit}</option><option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option></select>
        <input id="tmp-${k}-qty" type="number" min="0" step="1" placeholder="Cantidad" style="width:120px;padding:8px;border:1px solid #ddd;border-radius:6px">`;
      tp.appendChild(row);
    });
    box.querySelector('#tmp-create').addEventListener('click', () => {
      const nombre = box.querySelector('#tmp-name').value.trim(); const telefono = box.querySelector('#tmp-tel').value.trim();
      if(!nombre || !telefono) return alert('Nombre y teléfono requeridos');
      const items = {};
      Object.keys(productos).forEach(k => {
        const q = Number(box.querySelector(`#tmp-${k}-qty`).value) || 0;
        const u = box.querySelector(`#tmp-${k}-unit`).value || productos[k].baseUnit;
        if(q > 0) items[k] = { qty: q, unit: u };
      });
      if(Object.keys(items).length === 0) return alert('Añade al menos un producto');
      crearPedido({ nombre, telefono, items, comentarios: 'Creado por admin', creadoPorAdmin: true });
      wrapper.remove();
      notify('Pedido creado (admin)');
    });
  });

  // Payment modal controls
  $('close-payment').addEventListener('click', () => hideModal('payment-modal'));
  $('register-payment').addEventListener('click', () => {
    if(!currentPaymentPedidoId) return notify('No hay pedido seleccionado', 1600);
    const monto = Number($('payment-amount').value) || 0;
    const metodo = $('payment-method').value;
    const notas = $('payment-notes').value || '';
    if(monto <= 0) return alert('Ingresa un monto válido');
    registrarPago(currentPaymentPedidoId, { monto, metodo, notas, fecha: nowISO() });
    renderPaymentHistoryForPedido(currentPaymentPedidoId);
    notify('Pago registrado');
  });
  $('mark-as-paid').addEventListener('click', () => {
    if(!currentPaymentPedidoId) return notify('No hay pedido seleccionado', 1600);
    if(!confirm('Marcar todo como pagado?')) return;
    marcarTodoPagado(currentPaymentPedidoId);
    renderPaymentHistoryForPedido(currentPaymentPedidoId);
    notify('Pedido marcado como pagado');
  });
  $('toggle-payment-history').addEventListener('click', () => {
    const el = $('payment-history-container');
    if(el.style.display === 'block') el.style.display = 'none';
    else { el.style.display = 'block'; if(currentPaymentPedidoId) renderPaymentHistoryForPedido(currentPaymentPedidoId); }
  });

  // Save/Reset products
  $('save-products-btn').addEventListener('click', () => {
    Object.keys(productos).forEach(k => {
      productos[k].nombre = $(`cfg-${k}-name`).value || productos[k].nombre;
      productos[k].precio = Number($(`cfg-${k}-price`).value) || productos[k].precio;
      productos[k].baseUnit = $(`cfg-${k}-baseunit`).value || productos[k].baseUnit;
      productos[k].disponible = $(`cfg-${k}-avail`).value === 'true';
    });
    saveAll(); renderAll(); notify('Productos guardados');
  });
  $('reset-products-btn').addEventListener('click', () => {
    if(!confirm('Restablecer productos a valores por defecto?')) return;
    productos = structuredClone(DEFAULT_PRODUCTOS);
    saveAll(); renderAll(); notify('Productos restaurados');
  });

  // Search/filter events
  $('search-input').addEventListener('input', e => renderOrders(e.target.value || '', $('payment-filter').value || 'all'));
  $('payment-filter').addEventListener('change', () => renderOrders($('search-input').value || '', $('payment-filter').value || 'all'));
}

/* ====== CSV export helpers ====== */
function buildOrdersCSV(){
  const header = ['ID','Nombre','Telefono','Fecha','Productos','Comentarios','Total','Estado','DeudaPendiente','PaymentMethod'];
  const rows = [header];
  pedidos.forEach(p => {
    const items = [];
    if(p.items.paltas && p.items.paltas.qty) items.push(`${p.items.paltas.qty} ${p.items.paltas.unit} Paltas`);
    if(p.items.champi && p.items.champi.qty) items.push(`${p.items.champi.qty} ${p.items.champi.unit} Champiñones`);
    if(p.items.frutillas && p.items.frutillas.qty) items.push(`${p.items.frutillas.qty} ${p.items.frutillas.unit} Frutillas`);
    rows.push([p.id, p.nombre, p.telefono, p.fecha, items.join(' | '), p.comentarios || '', p.total, p.estadoPago, p.deudaPendiente, p.paymentMethod || '']);
  });
  return rows;
}
function exportCSV(filename, rows){
  const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ====== Initial load & render ====== */
(function init(){
  loadAll();
  if(localStorage.getItem('isAdmin')){
    isAdmin = true;
    $('admin-container').style.display = 'block';
  } else {
    $('admin-container').style.display = 'none';
  }
  setupListeners();
  renderAll();

  // default paltas qty to 1 for convenience after render
  setTimeout(()=> { document.querySelectorAll('.client-qty').forEach(i => { if(i && i.getAttribute('data-product') === 'paltas') i.value = 1; }); }, 200);
})();

/* ====== renderAll wraps product/admin/ orders ====== */
function renderAll(){
  renderProductGrid();
  renderProductsAdmin();
  renderOrders($('search-input')?.value || '', $('payment-filter')?.value || 'all');
}

/* ====== Render products admin (build inputs) ====== */
function renderProductsAdmin(){
  const container = $('products-admin'); container.innerHTML = '';
  Object.keys(productos).forEach(k => {
    const p = productos[k];
    const row = document.createElement('div'); row.className = 'prod-admin-row';
    row.innerHTML = `
      <input id="cfg-${k}-name" value="${escapeHTML(p.nombre)}">
      <input id="cfg-${k}-price" type="number" value="${p.precio}">
      <select id="cfg-${k}-baseunit">
        <option value="kg">kg</option><option value="g">g</option><option value="caja">caja</option><option value="saco">saco</option>
      </select>
      <select id="cfg-${k}-avail" class="avail">
        <option value="true">Disponible</option><option value="false">No</option>
      </select>
    `;
    container.appendChild(row);
    $(`cfg-${k}-baseunit`).value = p.baseUnit || 'kg';
    $(`cfg-${k}-avail`).value = p.disponible ? 'true' : 'false';
  });
}

/* ====== Safe helper for cloning nodes (to avoid duplicate listeners) ====== */
function safeReplace(node){
  const clone = node.cloneNode(true);
  node.parentNode.replaceChild(clone, node);
  return clone;
}
</script>
</body>
</html>
